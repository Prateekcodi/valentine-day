# Valentine Week Deployment Guide

## Quick Setup Checklist

### 1. Railway (Backend + Database)

**Required Environment Variables:**
- `PORT`: `3001`
- `CORS_ORIGIN`: Your Vercel frontend URL (e.g., `https://valentine-day-sandy-seven.vercel.app`)
- `MONGODB_URI`: MongoDB connection string (REQUIRED for persistent room data!)
  - Get free MongoDB Atlas: https://www.mongodb.com/cloud/atlas
  - Format: `mongodb+srv://<username>:<password>@cluster.mongodb.net/valentine_week`

**Optional AI API Keys (for AI reflections):**
- `GEMINI_API_KEY`: Get from https://ai.google.dev/
- `OPENROUTER_API_KEY`: Get from https://openrouter.ai/keys

### 2. Vercel (Frontend)

**Required Environment Variables:**
| Name | Value |
|------|-------|
| `NEXT_PUBLIC_API_URL` | Your Railway backend URL (e.g., `https://valentine-week-production.up.railway.app`) |
| `NEXT_PUBLIC_SOCKET_URL` | Your Railway backend URL with WebSocket (e.g., `https://valentine-week-production.up.railway.app`) |

**Important:** Both URLs must be the same and point to your Railway deployment!

## Common Issues & Fixes

### Issue: WebSocket connecting to localhost:3001

**Solution:** Add `NEXT_PUBLIC_SOCKET_URL` in Vercel:
1. Go to Vercel Dashboard → Your Project → Settings → Environment Variables
2. Add: `NEXT_PUBLIC_SOCKET_URL` = Your Railway URL (e.g., `https://valentine-week-production.up.railway.app`)
3. Redeploy

### Issue: Room data not found / 404 errors

**Solution:** Add `MONGODB_URI` in Railway:
1. Create free MongoDB Atlas account
2. Create cluster and get connection string
3. Add to Railway: `MONGODB_URI` = your connection string
4. Redeploy

### Issue: Reflection not generating / Partner data not showing

**Root Causes:**
1. WebSocket not connecting (fix: add NEXT_PUBLIC_SOCKET_URL)
2. Room data lost (fix: add MONGODB_URI)

After adding the environment variables, both partners need to:
1. Rejoin the room (create new room or rejoin existing)
2. Both submit their messages
3. Reflection will be generated by AI when both submit

## Testing Your Deployment

1. **Test WebSocket:** Open browser console, should show "Socket connected" (not localhost)
2. **Test API:** Check network tab, API calls should go to your Railway URL (not localhost)
3. **Test Room:** Create a room, both partners join, submit on same day
4. **Test Reflection:** After both submit, AI reflection should appear

## Architecture

```
┌─────────────────┐         ┌─────────────────────┐
│   Vercel        │         │      Railway        │
│   (Frontend)    │────────▶│   (Backend + DB)   │
│                 │  API    │                     │
│ Next.js         │◀────────│ Express + Socket.io │
│                 │  WS     │ MongoDB             │
└─────────────────┘         └─────────────────────┘
```

## Manual Deploy Commands (if needed)

```bash
# Build frontend
cd apps/web
npm run build

# Build backend
cd apps/server
npm run build

# Start backend locally
npm start
```
